<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- Bootstrap core CSS -->
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
    <!-- mapping library-->
    <script src='bower_components/leaflet/dist/leaflet.js'></script>
    <!-- functionnal sugar-->
    <script src="bower_components/underscore/underscore-min.js"></script>
    <!-- local storage database, should allow syncing to cnetral database in time-->
    <script src="bower_components/pouchdb/dist/pouchdb.min.js"></script>
    <!-- provide a way for the user to save some data as a file-->
    <script src="bower_components/FileSaver.js/FileSaver.min.js"></script>
    <!-- because json serialization is still not a thing in javascript... -->
    <script src="json2.js"></script>
    <!-- sucky date handling in java* language seems to be a constant-->
    <script src="bower_components/moment/min/moment.min.js"></script>
    <!--  <script src="https://pouch.host/pouch.host.js"></script> -->

    <style>
#map { height: 480px; }
    </style>
  </head>
  <body>
    <!-- bootsrap modal html code -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModal-label" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
              <span class="sr-only">Close</span>
            </button>
            <h4 class="modal-title" id="myModal-label">Note</h4>
          </div>
          <div class="modal-body">
            <div class="container-fluid">
            <textarea id="myModal-content" class="form-control"> </textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="myModal-save">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div id="map"></div>
      <hr>
      <h3>Clickety click</h3>
      <p>Clicking on the map will add a marker with a default note</p>
      <p>Notes will popup when mousing over a marker, they can be closed by clicking on it or mousing over another marker</p>
      <p>Double-clicking on a marker will allow you to edit its note</p>
      <p>Double-clicking on the map will zoom</p>
      <h3>Data management</h3>
      <p>Data is automatically stored in your browser local storage, you can use the button below to save it on your computer
      <button type="button" class="btn btn-primary" onClick="javascript:onDownload();">Download your data</button></p>
      <p>Once saved you can send the file to somebody else and they will be able to add them to their map using the following button
      <button type="button" class="btn btn-primary" onClick="javascript:upload();">Upload data</button></p>
      <p>You can delete all the data on this map using
      <button type="button" class="btn btn-danger" onClick="javascript:deletedb();">Delete map</button></p>
    </div>



    <!-- Bootstrap core JavaScript-->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="bower_components/jquery/dist/jquery.min.js"><\/script>')</script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script>
//init the DB in local storage
var db = new PouchDB('souvenirs');
//var sync;

//init the map in Bretagne
var bretagne = new L.latLng(48.809, -3.373);
var map = L.map('map', {attributionControl:false}).setView(bretagne, 8);
map.clickBounce = 0;
var debounceTimeout = 300;

var allLayers = L.layerGroup();

//add the osm tiles
var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 20});   
map.addLayer(osm);

var osmAttrib='Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
map.addControl(new L.control.attribution({prefix:false}).addAttribution(osmAttrib));

//when clicking the map add a marker
map.on('click', function(e) {
  map.clickBounce= map.clickBounce+ 1;
  setTimeout(function(){
    if(map.clickBounce == 1){
      //saving the marker in the DB
      db.post({
        latlng: e.latlng
      }).then(function(res) {
        console.log('marker saved');
        
        addMakerToMap(res.id, {latlng: e.latlng, note: 'something cool here'});
      }).catch(function(err) {
        console.log('could not save marker');
        console.log(err);
      });
      map.clickBounce= 0;
    }
  }, debounceTimeout);
});

//debouncing single clicks
map.on('dblclick', function(event){
  map.clickBounce= 0;
  map.zoomIn();
});

var markerInModal;

function addMakerToMap(id, markerDoc) {

  console.log('adding marker at '+markerDoc.latlng.lat+','+markerDoc.latlng.lng);

  marker = L.marker(markerDoc.latlng, { draggable:'true'});
  allLayers.addLayer(marker);
  marker.id = id;
  marker.bindPopup(markerDoc.note || 'nothing');
  //updating the marker position when drag is over
  marker.on('dragend', function(event){
    db.get(id).then(function(doc) {
      console.log('updating marker position to '+event.target.getLatLng());
      doc.latlng = event.target.getLatLng();
      return db.put(doc);
    }).then(function(response) {
      console.log('marker position updated');
    }).catch(function (err) {
      console.log('could not update the marker position');
      console.log(err);
    });
  });
  marker.on('mouseover', function(event) {
    event.target.openPopup();
  });
  //opening the modal loaded with the popup content on dblclick
  marker.on('dblclick', function(event) {
    markerInModal={
      marker:event.target,
      id:event.target.id
    };

  //when closing the modal with the save button we update
  //the popup and save the new version in the db
    showTextareModal(event.target.getPopup().getContent(), 'What is it about this place that you would like to write about?', 'update note', function(event) {
      var marker = markerInModal.marker;
      var id = markerInModal.id;
      var note = $('#myModal-content').val();
      marker.getPopup().setContent(note);
      $('#myModal').modal('hide');

      db.get(id).then(function(doc) {
        console.log('updating marker text to '+marker.getLatLng());
        doc.note = note;
        return db.put(doc);
      }).then(function(response) {
        console.log('marker note updated');
      }).catch(function (err) {
        console.log('could not update the marker note');
        console.log(err);
      });
    });
  });
  marker.addTo(map);
}

function showTextareModal(content, placeholder, confirmVerb, onSaveEventHandler) {
    $('#myModal-content').attr('placeholder', placeholder).val(content);
    $('#myModal').modal();
    $('#myModal-save').html(confirmVerb).on('click', onSaveEventHandler);
}


function pushBoundaries(latlng, southWest, northEast) {

  if (latlng.lat < southWest.lat) {
    southWest.lat = latlng.lat;
  } else if (latlng.lat >northEast.lat) {
    northEast.lat = latlng.lat;
  }
  if (latlng.lng < southWest.lng) {
    southWest.lng = latlng.lng;
  } else if (latlng.lng >northEast.lng) {
    northEast.lng = latlng.lng;
  }
  
}

function makeSomeSpace(southWest, northEast) {

    southWest.lat = southWest.lat-0.1;
    northEast.lat = northEast.lat+0.1;
    southWest.lng = southWest.lng-0.1;
    northEast.lng = northEast.lng+0.1;
  
}

db.allDocs({
  include_docs:true
}).then(function(res) {
//show all known markers on the map on startup
  var southWest = {lat:bretagne.lat, lng:bretagne.lng};
var northEast = {lat:bretagne.lat, lng:bretagne.lng};
  console.log('found '+res.rows.length+' markers');
  _.each(res.rows, function(markerInfos) {
    addMakerToMap(markerInfos.id, markerInfos.doc);
    pushBoundaries(markerInfos.doc.latlng, southWest, northEast);
  });
  //moving the map to include all markers
  console.log('boundaries of known points are '+southWest.lat+','+southWest.lng+' by '+northEast.lat+','+northEast.lng);
  makeSomeSpace(southWest, northEast);
  console.log('boundaries of known points are '+southWest.lat+','+southWest.lng+' by '+northEast.lat+','+northEast.lng);
  map.fitBounds(L.latLngBounds(southWest, northEast));
}).catch(function(err) {
  console.log('could not fetch existing documents');
  console.log(err);
});



function dbinfos() {
  db.info().then(function (info) {
    console.log(info);
  });
}

function deletedb() {
  db.allDocs({
    include_docs:true
  }).then(function(res) {
    _.each(res.rows, function(markerInfos) {
      console.log('deleting marker at '+markerInfos.doc.latlng);
      db.remove(markerInfos.doc);
    });
  });

  //remove marker from map
  allLayers.eachLayer(function (layer) {
    map.removeLayer(layer);
  });

}

function onDownload() {
  db.allDocs({
    include_docs:true
  }).then(function(res) {
    data = JSON.stringify(res.rows);
    var blob = new Blob([data], {type: "application/json"});
    saveAs(blob, "souvecarte_"+moment().format('YYYY-MM-DDTHH:mm')+".json");
  });
}

function upload() {
  //TODO group all uploaded marker in another group layer to allow undo of upload
    showTextareModal('','paste here data downloaded from this site', 'add', function(event) {
      var data = $('#myModal-content').val();

      var rows = JSON.parse(data);      
      _.each(rows, function(row) {

        db.get(row.id).then(function(doc) {
          //already known marker, do not do anything
          console.log('not adding already present marker '+row.id);
        }).catch(function (err) {
          if (err.status == 404) {
            delete row.doc._rev;
            db.put(row.doc);
            addMakerToMap(row.id, row.doc);
          } else {
            console.log('error fetching from database prior to upload');
            console.log(err);
          }
        });
      });
      $('#myModal').modal('hide');

    });
}

/*
   function login() {
   PouchHost.login({
   email: 'rouadec@gmail.com'
   });
   }
   PouchHost.options('server', 'http://pimpator.com:3030/');

   PouchHost.session().then(function (result) {
   if (result.ok) {
// We have a valid session, sync!
console.log('session found, synchronizing to '+result.db);
db.sync(
result.db, {live: true}
).then(function(res){
console.log('synchronization ok');
console.log(res);
}).catch(function(err) {
console.log('could not synchronize');
console.log(err);
});
}
});
 */
//waiting for the DOM to be ready
$(document).ready(function() {
  
});

    </script>
  </body>
</html>
