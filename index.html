<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
  <script src='bower_components/leaflet/dist/leaflet.js'></script>
  <script src="bower_components/underscore/underscore-min.js"></script>
  <script src="bower_components/pouchdb/dist/pouchdb.min.js"></script>

  <style>
#map { height: 480px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
//init the DB in local storage
var db = new PouchDB('souvenirs');

//init the map in Bretagne
var map = L.map('map', {attributionControl:false}).setView([48.809, -3.373], 8);
map.clickBounce = 0;
var debounceTimeout = 300;

//add the osm tiles
var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 20});   
map.addLayer(osm);

var osmAttrib='Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
map.addControl(new L.control.attribution({prefix:false}).addAttribution(osmAttrib));

//when clicking the map add a marker
map.on('click', function(e) {
  map.clickBounce= map.clickBounce+ 1;
  setTimeout(function(){
    if(map.clickBounce == 1){
      //saving the marker in the DB
      db.post({
        latlng: e.latlng
      }).then(function(res) {
        console.log('marker saved');
        addMakerToMap(res.id, e.latlng);
      }).catch(function(err) {
        console.log('could not save marker');
        console.log(err);
      });
      map.clickBounce= 0;
    }
  }, debounceTimeout);
});

map.on('dblclick', function(event){
  //debouncing single clicks
  map.clickBounce= 0;
  map.zoomIn();
});

function addMakerToMap(id, latlng) {
  marker = L.marker(latlng, { draggable:'true'});
  marker.on('dragend', function(event){
    db.get(id).then(function(doc) {
      console.log('updating marker position to '+event.target.getLatLng());
      return db.put({
        _id: id,
        _rev: doc._rev,
        latlng:event.target.getLatLng()
      });
    }).then(function(response) {
      console.log('marker position updated');
    }).catch(function (err) {
      console.log('could not update the marker position');
      console.log(err);
    });
  });
  marker.addTo(map);
}

//show all known markers on the map
db.allDocs({
  include_docs:true
}).then(function(res) {
  console.log('found '+res.rows.length+' markers');
  _.each(res.rows, function(markerInfos) {
    addMakerToMap(markerInfos.id, markerInfos.doc.latlng);
  });
}).catch(function(err) {
  console.log('could not fetch existing documents');
  console.log(err);
});

function dbinfos() {
  db.info().then(function (info) {
      console.log(info);
  });
}

function deletedb() {
  db.allDocs({
    include_docs:true
  }).then(function(res) {
    _.each(res.rows, function(markerInfos) {
      console.log('deleting marker at '+markerInfos.doc.latlng);
      db.remove(markerInfos.doc);
    });
  });
}

  </script>
</body>
</html>
