<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
  <script src='bower_components/leaflet/dist/leaflet.js'></script>
  <script src="bower_components/underscore/underscore-min.js"></script>
  <script src="bower_components/pouchdb/dist/pouchdb.min.js"></script>

  <style>
#map { height: 480px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
var db = new PouchDB('souvenirs');

var map = L.map('map').setView([48.809, -3.373], 8);
var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osmAttrib='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 20, attribution: osmAttrib});   

// start the map in South-East England
//map.setView(new L.LatLng(51.3, 0.7),9);
map.addLayer(osm);

map.on('click', function(e) {
  //gib_uni();
  db.post({
    latlng: e.latlng
  }).then(function(res) {
    console.log('marker saved');
    console.log(res);
  }).catch(function(err) {
    console.log('could not save marker');
    console.log(err);
  });
  addMakerToMap(e.latlng);
});

function addMakerToMap(latlng) {
  marker = L.marker(latlng, { draggable:'true'});
  marker.on('dragend', function(event){
    //var marker = event.target;
    var position = marker.getLatLng();
    //alert(position);
    //marker.setLatLng([position],{draggable:'true'}).bindPopup(position).update();
  });
  marker.addTo(map);
}


db.allDocs({
  include_docs:true
}).then(function(res) {
  console.log('found '+res.rows.length+' markers');
  _.each(res.rows, function(markerInfos) {
    addMakerToMap(markerInfos.doc.latlng);
  });
}).catch(function(err) {
  console.log('could not fetch existing documents');
  console.log(err);
});

function dbinfos() {
  db.info().then(function (info) {
      console.log(info);
  });
}

function deletedb() {
  db.allDocs({
    include_docs:true
  }).then(function(res) {
    _.each(res.rows, function(markerInfos) {
      console.log('deleting marker at '+markerInfos.doc.latlng);
      db.remove(markerInfos.doc);
    });
  });
}

  </script>
</body>
</html>
